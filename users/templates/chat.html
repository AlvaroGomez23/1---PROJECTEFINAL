<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <title>Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }

        h1 {
            margin: 20px 0;
        }

        #chat-container {
            width: 90%;
            max-width: 600px;
            height: 400px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background-color: #dcf8c6; /* Verde claro */
            color: #000;
        }

        .message.received {
            align-self: flex-start;
            background-color: #ffffff; /* Blanco */
            border: 1px solid #ddd;
            color: #000;
        }

        #message-input-container {
            width: 90%;
            max-width: 600px;
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background-color: #25d366; /* Verde WhatsApp */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #1da851;
        }
    </style>
    <script>
        const conversationId = "{{ conversation_id }}";
        const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
        const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/${conversationId}/`);

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);

            // Si se reciben todos los mensajes
            if (data.messages) {
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = ''; // Limpiar el contenedor

                // Procesar cada mensaje
                data.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');

                    // Verificar si el mensaje fue enviado por el usuario actual
                    if (msg.sender === "{{ request.user.username }}") {
                        messageDiv.classList.add('message', 'sent'); // Mensajes enviados
                        messageDiv.textContent = `${msg.content}`;
                    } else {
                        messageDiv.classList.add('message', 'received'); // Mensajes recibidos
                        messageDiv.textContent = `${msg.content}`;
                    }

                    chatContainer.appendChild(messageDiv);
                });

                // Desplazar hacia abajo automáticamente
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Si se recibe un mensaje nuevo
            if (data.message) {
                const data = JSON.parse(event.data);
    const chatContainer = document.getElementById('chat-container');

    // Si el mensaje proviene del propio usuario, no lo agregamos de nuevo
    if (data.sender === "{{ request.user.username }}") {
        return;
    }

    // Mostrar el mensaje como recibido
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'received'); // Mensajes recibidos
    messageDiv.textContent = data.message;
    chatContainer.appendChild(messageDiv);

    // Desplazar hacia abajo automáticamente
    chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        };

        ws.onclose = function() {
            console.warn("⚠️ WebSocket cerrado.");
        };

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value;

            if (message.trim() === "") return;

            // Generar un identificador único para el mensaje
            const messageId = Date.now(); // Usar un timestamp como identificador único

            // Enviar el mensaje al servidor
            ws.send(JSON.stringify({
                'message': message,
                'sender': "{{ request.user.username }}",
                'id': messageId // Incluir el identificador único
            }));

            // Mostrar el mensaje en el chat como enviado
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'sent'); // Mensajes enviados
            messageDiv.textContent = message;
            messageDiv.dataset.id = messageId; // Guardar el identificador único en el DOM
            chatContainer.appendChild(messageDiv);

            // Desplazar hacia abajo automáticamente
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Limpiar el campo de entrada
            messageInput.value = '';
        }
    </script>
</head>
<body>
    <h1>Xat amb {{ other_user.first_name }}</h1> <!-- Mostrar el nombre del remitente -->
    <div id="chat-container">
        <!-- Aquí se agregarán los mensajes dinámicamente -->
    </div>
    <div id="message-input-container">
        <input id="message-input" type="text" placeholder="Escribe un mensaje..." />
        <button onclick="sendMessage()">Enviar</button>
        <a href="{% url 'inbox' %}">Tornar al inbox</a>
    </div>
</body>
</html>